---
title: "ç°¡å˜ã« rails API ã‚’å®Ÿè£…ã—ã¦ã¿ãŸ"
emoji: "ğŸ‘»"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["ruby", "rails", "api", "docker"]
published: true
---

# Docker

å‚è€ƒ

https://zenn.dev/trysmr/articles/b9c99302ebc205

æœ¬è¨˜äº‹ã§ã¯ã€web ã‚³ãƒ³ãƒ†ãƒŠã®ãƒãƒ¼ãƒˆã‚’ 80:3000 ã§å®Ÿè£…ã—ã¦ã„ã‚‹

# rails API å®Ÿè£…

## cors è¨­å®š

`Gemfile`

```ruby_diff
+ gem 'rack-cors'
```

`config/initializers/cors.rb`

```ruby
Rails.application.config.middleware.insert_before 0, Rack::Cors do
  allow do
    origins 'http://localhost:3000'

    resource '*',
      headers: :any,
      methods: [:get, :post, :put, :patch, :delete, :options, :head]
  end
end
```

## ãƒ­ã‚°ã‚¤ãƒ³æ©Ÿèƒ½å®Ÿè£…

devise ã‚’ä½¿ç”¨ã™ã‚‹

### ãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‚¤ãƒ³ã‚¹ãƒˆãƒ¼ãƒ«

`Gemfile`

```ruby
gem 'devise'
gem 'devise_token_auth'
```

### User ä½œæˆ

```bash
bin/rails generate devise:install
bin/rails generate devise User
bin/rails generate devise_token_auth:install User auth
bin/rails db:migrate
```

### ãƒ¡ãƒ¼ãƒ«èªè¨¼è¨­å®š

ä»Šå›ã¯ä½¿ç”¨ã—ãªã„ã€‚

`config/envioroments/development.rb`

```ruby
config.action_mailer.default_url_options = { host: 'localhost', port: 3000 }
```

## èªè¨¼å‘¨ã‚Šå®Ÿè£…

### å„ç¨®ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ä½œæˆ

```bash
bin/rails g controller auth/registrations
bin/rails g controller auth/sessions
```

`auth/registrations_controller.rb`

```ruby
class Auth::RegistrationsController < DeviseTokenAuth::RegistrationsController
  private
    def sign_up_params
      params.permit(:email, :password, :password_confirmation, :name)
    end
end
```

`auth/sessions_controller.rb`

```ruby
class Auth::SessionsController < ApplicationController
  def index
    if current_api_v1_user
      render json: { is_login: true, data: current_api_v1_user }
    else
      render json: { is_login: false, message: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒå­˜åœ¨ã—ã¾ã›ã‚“" }
    end
  end
end
```

`application_controller.rb`

```ruby
class ApplicationController < ActionController::API
  include DeviseTokenAuth::Concerns::SetUserByToken

  skip_before_action :verify_authenticity_token
  helper_method :current_user, :user_signed_in?
end
```

`config/routes.rb`

```ruby
Rails.application.routes.draw do
  mount_devise_token_auth_for 'User', at: 'auth', controllers: {
    registrations: 'auth/registrations'
  }

  namespace :auth do
    resources :sessions, only: %i[index]
  end
end
```

### API ç¢ºèª

ãƒ¦ãƒ¼ã‚¶ä½œæˆ

```bash
curl -X POST http://localhost/auth -d '[name]=test&[email]=test@example.com&[password]=password&[password_confirmation]=password'
```

ãƒ¦ãƒ¼ã‚¶ãƒ­ã‚°ã‚¤ãƒ³

```bash
curl -X POST -v http://localhost/auth/sign_in -d '[email]=test@example.com&[password]=password'
```

# ä¼šè­°å®¤äºˆç´„ç®¡ç†ä½œæˆ

### ãƒªã‚½ãƒ¼ã‚¹ä½œæˆ

```bash
bin/rails g scaffold Rooms name:string
bin/rails g scaffold Meetings user:references room:references start_at:datetime end_at:datetime
bin/rails db:migrate
```

`config/routes.rb`

```ruby
  resources :rooms
  resources :meetings
```

### curl ã§ç¢ºèª

#### ä¼šè­°å®¤ç™»éŒ²

```bash
curl -X POST -H "Content-Type: application/json" -d '{"room": {"name": "ä¼šè­°å®¤A"}}' http://localhost/rooms
```

#### ä¼šè­°ç™»éŒ²

```bash
curl -X POST -H "Content-Type: application/json" -d '{"meeting": {"user_id": "1", "room_id":"1", "start_at":"2024-01-01 10:00:00", "end_at": "2024-01-01 11:00:00"}}' http://localhost/meetings
```

### ãƒªãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³æ•´ç†

`/rooms/:room_id/meetings`
room_id ã§çµã‚Šè¾¼ã¾ã‚ŒãŸ meetings ã®ãƒ¬ã‚³ãƒ¼ãƒ‰ãŒè¿”ã£ã¦ãã‚‹ã‚ˆã†ã«ã™ã‚‹

`models/room.rb`

```ruby
class Room < ApplicationRecord
  has_many :meetings
end
```

`models/meeting.rb`

```ruby
class Meeting < ApplicationRecord
  belongs_to :room
  belongs_to :user
end
```

`config/routes.rb`

```ruby
  resources :rooms do
    resources :meetings, only: [:index]
  end

```

`meeting_controller.rb`

```diff_ruby
  # GET /meetings
  def index
-   @meetings = Meeting.all
+   @meetings = Meeting.where(where_params)

    render json: @meetings
  end

...
    # Only allow a list of trusted parameters through.
    def meeting_params
      params.require(:meeting).permit(:user_id, :room_id, :start_at, :end_at)
    end

+   def where_params
+   params.permit(:room_id, :start_at, :end_at)
+   end
```

æ—¢ã«ãã®æ—¥æ™‚ã§äºˆç´„ãŒã¨ã‚‰ã‚Œã¦ã„ã‚‹å ´åˆã¯äºˆç´„ã§ããªã„ã‚ˆã†ã«ã™ã‚‹
`meetings_controller.rb`

```ruby
class MeetingsController < ApplicationController
  before_action :set_meeting, only: [:show, :update, :destroy]

  # GET /meetings
  def index

    if where_params[:room_id].present?
      @meetings = Meeting.where(room_id: where_params[:room_id])
    else
      @meetings = Meeting.all
    end

    if where_params[:start_at].present?
      @meetings = @meeting.where(start_at: where_params[:start_at]...)
    else
      current_time = Time.zone.now
      rounded_time = current_time.change(hour: 0, min: 0, sec: 0)
      @meetings = @meetings.where(start_at: rounded_time...)
    end

    if where_params[:end_at].present?
      @meetings = @meeting.where(start_at: ...where_params[:start_at])
    end

    render json: @meetings
  end

  # GET /meetings/1
  def show
    render json: @meeting
  end

  # POST /meetings
  def create
    @meeting = Meeting.new(meeting_params)
    is_not_exists = Meeting.where(
      "(start_at >= ? AND start_at < ?) OR (end_at > ? AND end_at <= ?)",
      meeting_params[:start_at], meeting_params[:end_at], meeting_params[:start_at], meeting_params[:end_at]
    ).where(room_id: meeting_params[:room_id]).empty?

    if is_not_exists && @meeting.save
      render json: @meeting, status: :created, location: @meeting
    else
      render json: @meeting.errors, status: :unprocessable_entity
    end
  end

  # PATCH/PUT /meetings/1
  def update
    if @meeting.update(meeting_params)
      render json: @meeting
    else
      render json: @meeting.errors, status: :unprocessable_entity
    end
  end

  # DELETE /meetings/1
  def destroy
    @meeting.destroy
  end

  private
    # Use callbacks to share common setup or constraints between actions.
    def set_meeting
      @meeting = Meeting.find(params[:id])
    end

    # Only allow a list of trusted parameters through.
    def meeting_params
      params.require(:meeting).permit(:user_id, :room_id, :start_at, :end_at)
    end

    def where_params
      params.permit(:room_id, :start_at, :end_at)
    end
end
```
